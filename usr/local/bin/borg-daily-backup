#!/bin/bash
set -e

notify() {
	echo "$1"
	notify-send -a "Daily backup" --icon=dialog-information "Daily backup" "$1"
}

REPOSITORY="$1"
if [ ! -d "$REPOSITORY" ]; then
	echo "No borg repository was provided" 1>&2
	exit 1
fi
if ! borg list "$REPOSITORY" &> /dev/null; then
	echo "Provided directory is not a valid borg repository" 1>&2
	exit 1
fi

if [ $# -lt 2 ]; then
	echo "Need to provide directories to backup" 1>&2
	exit 1
fi

date_backup=$(borg list --format '{time}' --sort-by timestamp --last 1 "$REPOSITORY" | awk '{print $2}')
if [ "$date_backup" ]; then
	timestamp_backup=$(date -d "$date_backup" +%s)
else
	timestamp_backup=0
fi
date_today=$(date -Idate)
timestamp_today=$(date -d "$date_today" +%s)

if [ $timestamp_backup -ge $timestamp_today ]; then
	echo "Already made the backup today, skipping..."
	exit 0
fi

notify "Making daily backup for $date_today..."
borg create -v -s --noatime -C lz4 "$REPOSITORY::$date_today" "${@:2}"
notify "Daily backup made for $date_today"
